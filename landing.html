<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Landing — collecte avancée</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:18px;max-width:920px;margin:auto}
    pre{background:#f6f8fa;padding:12px;border-radius:8px;overflow:auto}
    .bar{background:#fff7d6;border:1px solid #fde68a;padding:10px;border-radius:8px;margin-bottom:12px}
    .muted{color:#6b7280;font-size:13px}
    button{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="bar">
    Cette page collecte des informations techniques (navigateur, appareil, réseau…) pour l’analyse du scan QR.
    <span class="muted">Géoloc uniquement si autorisée. Voir JSON ci-dessous.</span>
  </div>

  <h1>Merci d’avoir scanné</h1>
  <p><b>Statut :</b> <span id="status">initialisation…</span></p>

  <p>
    <button id="sendBtn">Forcer l’envoi maintenant</button>
    <button id="geoBtn">Demander la géoloc</button>
  </p>

  <pre id="dump">…</pre>

<script>
/* ================= CONFIG ================= */
const DEFAULT_WEBHOOK_URL = 'https://webhook.site/3ff17bc2-1614-47e8-a254-77fd25e86dda'; // ← change-moi
/* ========================================= */

const $ = s => document.querySelector(s);
const setStatus = t => $('#status').textContent = t;
const showDump = o => $('#dump').textContent = JSON.stringify(o, null, 2);
const qs = new URLSearchParams(location.search);

const WEBHOOK_URL = qs.get('wh') || DEFAULT_WEBHOOK_URL;
const NTFY_TOPIC  = qs.get('topic') || 'qr-scann-test-1';
const AUTO_SEND   = (qs.get('autosend') ?? '1') !== '0'; // auto par défaut
const WANT_GEO    = (qs.get('geo') ?? '0') === '1';      // off par défaut

/* ---------- Collecte enrichie ---------- */
async function getIPAndGeo(){
  // Essaye ipapi.co, fallback ipwho.is
  try {
    const r = await fetch('https://ipapi.co/json/', {cache:'no-store'});
    if (r.ok) { const j = await r.json(); return { ip: j.ip, ip_geo: j }; }
  } catch(e){}
  try {
    const r = await fetch('https://ipwho.is/', {cache:'no-store'});
    if (r.ok) { const j = await r.json(); return { ip: j.ip, ip_geo: j }; }
  } catch(e){}
  return { ip: null, ip_geo: null };
}

async function getStorageEstimate(){
  try {
    if (navigator.storage && navigator.storage.estimate) {
      const est = await navigator.storage.estimate();
      return { quota: est.quota || null, usage: est.usage || null };
    }
  } catch(e){}
  return null;
}

function getWebGLInfo(){
  try {
    const c = document.createElement('canvas');
    const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
    if (!gl) return null;
    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    return {
      vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR),
      renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER)
    };
  } catch(e){ return { error: String(e) }; }
}

async function enumerateMedia(){
  try{
    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return null;
    const list = await navigator.mediaDevices.enumerateDevices();
    const counts = list.reduce((a,d)=>{ a[d.kind]=(a[d.kind]||0)+1; return a; }, {});
    return { counts, hasLabels: !!(list.find(d=>d.label)) };
  }catch(e){ return { error: String(e) }; }
}

async function getPermissions(){
  if (!navigator.permissions) return null;
  const names = ['geolocation','camera','microphone','notifications'];
  const out = {};
  await Promise.all(names.map(async n=>{
    try{
      const s = await navigator.permissions.query({name:n});
      out[n] = s.state; // 'granted' | 'denied' | 'prompt'
    }catch(e){ out[n] = 'unknown'; }
  }));
  return out;
}

function likelyDevice(ua){
  ua = (ua||'').toLowerCase();
  if (ua.includes('iphone')) return 'Apple iPhone';
  if (ua.includes('ipad')) return 'Apple iPad';
  if (ua.includes('android')) return 'Android';
  if (ua.includes('mac os') || ua.includes('macintosh')) return 'Mac';
  if (ua.includes('windows')) return 'Windows PC';
  return 'Inconnu';
}

async function collectAll(doGeoloc=false){
  const info = {};
  info.ts = new Date().toISOString();
  info.url = location.href;
  info.referrer = document.referrer || null;

  // UA/UA-CH
  info.userAgent = navigator.userAgent || null;
  try{
    if (navigator.userAgentData){
      info.uaData = { mobile: navigator.userAgentData.mobile ?? null, brands: navigator.userAgentData.brands ?? null };
      if (navigator.userAgentData.getHighEntropyValues){
        info.uaData.highEntropy = await navigator.userAgentData.getHighEntropyValues(
          ['platform','platformVersion','model','architecture','bitness','fullVersionList']
        );
      }
    }
  }catch(e){ info.uaDataError = String(e); }

  // Locale / time
  info.language = navigator.language || null;
  info.languages = navigator.languages || null;
  info.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || null;
  info.tzOffsetMin = new Date().getTimezoneOffset();

  // Device features
  info.platform = navigator.platform || null;
  info.vendor = navigator.vendor || null;
  info.device = {
    likely: likelyDevice(info.userAgent),
    model: info.uaData?.highEntropy?.model || null,
    hardwareConcurrency: navigator.hardwareConcurrency || null,
    deviceMemory: navigator.deviceMemory || null,
    maxTouchPoints: navigator.maxTouchPoints || 0
  };

  // Screen/viewport
  info.screen = { width: screen.width, height: screen.height, availWidth: screen.availWidth, availHeight: screen.availHeight, colorDepth: screen.colorDepth };
  info.viewport = { innerWidth, innerHeight, devicePixelRatio: window.devicePixelRatio };

  // Storage
  info.storage = await getStorageEstimate();

  // Battery
  try {
    if (navigator.getBattery) {
      const b = await navigator.getBattery();
      info.battery = { charging: b.charging, level: b.level, chargingTime: b.chargingTime, dischargingTime: b.dischargingTime };
    }
  } catch(e){ info.batteryError = String(e); }

  // Network
  try{
    const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (c) info.connection = { effectiveType: c.effectiveType, downlink: c.downlink, rtt: c.rtt, saveData: c.saveData };
  }catch(e){}

  // Permissions status
  info.permissions = await getPermissions();

  // Media devices (counts)
  info.media = await enumerateMedia();

  // Audio
  try { const ac = new (window.AudioContext||window.webkitAudioContext)(); info.audio = { sampleRate: ac.sampleRate }; ac.close(); } catch(e){}

  // WebGL/GPU
  info.webgl = getWebGLInfo();

  // MIME types
  try { info.mimeTypes = Array.from(navigator.mimeTypes || []).map(m=>({type:m.type,desc:m.description})); } catch(e){}

  // IP + geo by service
  const ip = await getIPAndGeo();
  info.ip = ip.ip;
  info.ip_geo = ip.ip_geo;

  // Geolocation (browser prompt) if requested
  if (doGeoloc && navigator.geolocation){
    info.geolocationPrompted = true;
    await new Promise(res=>{
      navigator.geolocation.getCurrentPosition(
        pos => { info.geolocation = { lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: pos.coords.accuracy }; res(); },
        err => { info.geolocation = { error: err.message || String(err.code) }; res(); },
        { enableHighAccuracy:false, maximumAge:60000, timeout:10000 }
      );
    });
  } else {
    info.geolocationPrompted = false;
  }

  return info;
}

/* ---------- Envoi ---------- */
async function sendWebhook(payload){
  try{
    const r = await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    return {ok:r.ok, status:r.status};
  }catch(e){ return {ok:false, error:String(e)}; }
}

function summarizeForNtfy(info){
  const uaBrands = info.uaData?.brands?.map(b=>b.brand||b.brandName).join(', ');
  return [
    `QR scan — ${info.device?.likely}${info.device?.model ? ' ('+info.device.model+')':''}`,
    `IP: ${info.ip || 'n/d'} • ${info.ip_geo?.country_name || info.ip_geo?.country || ''} ${info.ip_geo?.city ? '— '+info.ip_geo.city : ''}`,
    `OS: ${info.uaData?.highEntropy?.platform || info.platform || 'n/d'} • Browser: ${uaBrands || 'n/d'}`,
    `Langue: ${info.language || 'n/d'} • TZ: ${info.timezone || 'n/d'}`,
    `Écran: ${info.screen?.width}x${info.screen?.height} DPR ${info.viewport?.devicePixelRatio}`,
    info.connection ? `Réseau: ${info.connection.effectiveType||'n/d'} ~${info.connection.downlink||'?'} Mbps` : '',
    info.battery ? `Batterie: ${Math.round((info.battery.level||0)*100)}% ${info.battery.charging?'(charge)': ''}` : '',
    info.webgl ? `GPU: ${info.webgl.vendor || ''} ${info.webgl.renderer || ''}` : ''
  ].filter(Boolean);
}

async function sendNtfy(topic, title, lines, clickUrl=null){
  const headers = {'Content-Type':'text/plain; charset=utf-8','Title':title,'Tags':'qr,scan','Priority':'3'};
  if (clickUrl) headers['Click'] = clickUrl;
  try{
    await fetch(`https://ntfy.sh/${encodeURIComponent(topic)}`, { method:'POST', headers, body: lines.join('\n') });
  }catch(e){}
}

/* ---------- Main ---------- */
let payload = null;

async function run(doAutoSend=true, doGeo=false){
  setStatus('Collecte des informations…');
  const info = await collectAll(doGeo);
  payload = { event:'qr_scan', timestamp:new Date().toISOString(), scan_url: location.href, client: info };
  showDump(payload);
  setStatus(doAutoSend ? 'Envoi automatique…' : 'Prêt (envoi manuel possible).');

  if (!doAutoSend) return;

  // Envoi JSON complet
  const r = await sendWebhook(payload);
  if (r.ok) setStatus(`Envoyé vers webhook ✅ (status ${r.status})`);
  else setStatus('Échec envoi webhook — voir console');

  // Notif ntfy (résumé lisible). Click = ouvre le webhook (si c’est ton webhook.site).
  const lines = summarizeForNtfy(info);
  await sendNtfy(NTFY_TOPIC, 'QR scan détecté', lines, WEBHOOK_URL);
  setStatus('Notification ntfy envoyée ✅');
}

$('#sendBtn').onclick = () => run(true, false);
$('#geoBtn').onclick  = () => run(true, true);

// Lancement : autosend + géoloc selon query
run(AUTO_SEND, WANT_GEO);
</script>
</body>
</html>
