<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Landing — collecte d'infos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:18px;max-width:880px;margin:auto}
    pre{background:#f6f8fa;padding:12px;border-radius:8px;overflow:auto}
    button{padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .muted{color:#6b7280;font-size:14px}
    .ok{color:green}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <h1>Merci d’avoir scanné</h1>
  <p class="muted">Cette page collecte des informations techniques (navigateur, modèle si disponible, IP, etc.). La géolocalisation nécessite votre permission.</p>

  <p><b>Statut :</b> <span id="status">préparation…</span></p>

  <div>
    <pre id="dump">…</pre>
    <p>
      <button id="sendInfo">Envoyer les infos maintenant</button>
      <button id="askGeo">Demander la géoloc (facultatif)</button>
    </p>
    <p class="muted">Après envoi, ouvre ton <code>webhook.site</code> (ou ton serveur) pour voir le JSON complet.</p>
  </div>

<script>
/* ================== CONFIG : remplace ces valeurs ================== */
const WEBHOOK_URL = 'https://webhook.site/3ff17bc2-1614-47e8-a254-77fd25e86dda'; // <- remplace par ton URL webhook.site ou ton serveur
const NTFY_TOPIC = 'maison'; // <- remplace par ton topic ntfy (ex: qr-scann-test-1)
/* ================================================================= */

const $ = s => document.querySelector(s);
const setStatus = txt => { $('#status').textContent = txt; };
const showDump = obj => { $('#dump').textContent = JSON.stringify(obj, null, 2); };

async function collectClientInfo(){
  const info = {};
  info.ts = new Date().toISOString();
  info.url = location.href;
  info.referrer = document.referrer || null;
  info.userAgent = navigator.userAgent || null;
  info.language = navigator.language || null;
  info.languages = navigator.languages || null;
  info.platform = navigator.platform || null;
  info.cookieEnabled = navigator.cookieEnabled;
  info.doNotTrack = navigator.doNotTrack || navigator.msDoNotTrack || navigator.doNotTrack;
  info.screen = { width: screen.width, height: screen.height, availWidth: screen.availWidth, availHeight: screen.availHeight, colorDepth: screen.colorDepth };
  info.viewport = { innerWidth: innerWidth, innerHeight: innerHeight, devicePixelRatio: window.devicePixelRatio };
  info.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || null;

  // UA Client Hints
  try {
    if (navigator.userAgentData) {
      info.uaData = { mobile: navigator.userAgentData.mobile ?? null, brands: navigator.userAgentData.brands ?? null };
      if (navigator.userAgentData.getHighEntropyValues) {
        try {
          const high = await navigator.userAgentData.getHighEntropyValues(['platform','platformVersion','model','architecture','bitness','fullVersionList']);
          info.uaData.highEntropy = high;
        } catch(e){ info.uaData.highEntropyError = String(e); }
      }
    }
  } catch(e){ info.uaDataError = String(e); }

  // Connection API
  try {
    const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection || null;
    if (c) info.connection = { effectiveType: c.effectiveType || null, downlink: c.downlink || null, rtt: c.rtt || null, saveData: c.saveData || null };
  } catch(e){}

  // Battery
  try {
    if (navigator.getBattery) {
      const bat = await navigator.getBattery();
      info.battery = { charging: bat.charging, level: bat.level, chargingTime: bat.chargingTime, dischargingTime: bat.dischargingTime };
    }
  } catch(e){ info.batteryError = String(e); }

  // mimeTypes limited on mobile
  try { info.mimeTypes = Array.from(navigator.mimeTypes || []).map(m=>({type:m.type,desc:m.description})); } catch(e){}

  return info;
}

async function getPublicIP(){
  try{
    const res = await fetch('https://api.ipify.org?format=json', {cache:'no-store'});
    if(!res.ok) throw new Error('ipify error');
    const j = await res.json();
    return j.ip;
  }catch(e){
    return null; // fallback to server-side IP in webhook logs
  }
}

function askGeolocation(){
  return new Promise((resolve) => {
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(pos => {
      resolve({lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: pos.coords.accuracy});
    }, err => {
      resolve({error: err.message || err.code});
    }, {enableHighAccuracy:false, maximumAge:60000, timeout:10000});
  });
}

/* --- Envoi JSON complet vers webhook (ton serveur / webhook.site) --- */
async function sendToWebhook(payload){
  try{
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    return {ok: res.ok, status: res.status, text: await res.text().catch(()=>''), headers: Object.fromEntries(res.headers.entries())};
  }catch(e){
    return {ok:false, error: String(e)};
  }
}

/* --- Envoi notification lisible vers ntfy --- */
async function sendToNtfy(topic, title, lines, clickUrl=null){
  const headers = {
    'Content-Type': 'text/plain; charset=utf-8',
    'Title': title,
    'Priority': '3',
    'Tags': 'qr,scan'
  };
  if (clickUrl) headers['Click'] = clickUrl;
  const body = lines.filter(Boolean).join('\n');
  try{
    await fetch(`https://ntfy.sh/${encodeURIComponent(topic)}`, { method: 'POST', headers, body });
    return {ok:true};
  }catch(e){
    return {ok:false, error: String(e)};
  }
}

function summarize(info){
  const ua = info.userAgent || '';
  const model = info.uaData?.highEntropy?.model || null;
  const platform = info.uaData?.highEntropy?.platform || info.platform || null;
  const likely =
    /iphone/i.test(ua) ? 'Apple iPhone' :
    /ipad/i.test(ua) ? 'Apple iPad' :
    /android/i.test(ua) ? 'Android' :
    /windows/i.test(ua) ? 'Windows PC' :
    /mac os|macintosh/i.test(ua) ? 'Mac' : 'Appareil ?';
  const brands = info.uaData?.brands ? info.uaData.brands.map(b => b.brand || b.brandName || '').join(', ') : null;

  const lines = [
    `Scan QR — ${likely}${model ? ' ('+model+')' : ''}`,
    `IP: ${info.ip || 'inconnue (voir serveur)'}`,
    `OS: ${platform || 'n/d'} • Browser: ${brands || 'n/d'}`,
    `Langue: ${info.language || 'n/d'} • TZ: ${info.timezone || 'n/d'}`,
    `Écran: ${info.screen?.width || '?'}x${info.screen?.height || '?'} DPR ${info.viewport?.devicePixelRatio || '?'}`,
    info.connection ? `Réseau: ${info.connection.effectiveType || '?'} ~${info.connection.downlink || '?'} Mbps` : '',
    info.battery ? `Batterie: ${Math.round((info.battery.level||0)*100)}% ${info.battery.charging? '(charging)':''}` : '',
    `UA: ${ua}`
  ];
  return lines;
}

/* ========== Main flow ========== */
let collected = null;

async function buildInfo(doGeoloc=false){
  setStatus('Collecte des informations…');
  const info = await collectClientInfo();
  info.ip = await getPublicIP(); // fallback
  if(doGeoloc){
    setStatus('Demande géoloc (permission)…');
    info.geolocation = await askGeolocation();
  }
  collected = {
    event: 'qr_scan',
    timestamp: new Date().toISOString(),
    scan_url: location.href,
    client: info
  };
  showDump(collected);
  setStatus('Prêt. Clique "Envoyer les infos" pour poster.');
}

$('#sendInfo').onclick = async () => {
  if(!collected) {
    setStatus('Rien à envoyer — collecte en cours…');
    await buildInfo(false);
  }
  setStatus('Envoi vers webhook…');
  const r = await sendToWebhook(collected);

  if (r.ok) {
    setStatus('Envoyé vers webhook ✅ (status ' + r.status + ')');
    $('.ok')?.remove?.();
  } else {
    setStatus('Échec envoi webhook — voir console');
    console.error('Webhook send error', r);
  }

  // Envoi résumé vers ntfy
  setStatus('Envoi résumé vers ntfy…');
  const info = collected.client;
  const lines = summarize(info);
  // clickUrl renvoie vers ta page webhook.site (ou le log). Si tu utilises webhook.site, remplace par ton URL.
  const clickUrl = WEBHOOK_URL; // utile: ouvre le log complet en 1 tap
  const ntfyRes = await sendToNtfy(NTFY_TOPIC, 'QR scan détecté', lines, clickUrl);
  if(ntfyRes.ok) setStatus('Notification ntfy envoyée ✅');
  else { setStatus('Échec envoi ntfy — voir console'); console.error('ntfy error', ntfyRes); }
};

$('#askGeo').onclick = async () => {
  setStatus('Demande géoloc…');
  await buildInfo(true);
};

/* Auto-run (collecte initiale sans geoloc) */
buildInfo(false);
</script>
</body>
</html>
