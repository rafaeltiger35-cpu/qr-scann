<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>QR: Générateur (local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px;max-width:720px;margin:auto}
    label{display:block;margin:12px 0 4px}
    input,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
    button{cursor:pointer}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:16px}
    canvas{max-width:100%;height:auto;margin-top:12px}
    .error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px;border-radius:8px;display:none}
    .hint{font-size:14px;color:#555}
  </style>
</head>
<body>
  <h1>Générer un QR pour traquer les scans</h1>

  <div class="error" id="err"></div>

  <div class="card">
    <label>Topic ntfy (ex: qr-scann-test-1)</label>
    <input id="topic" placeholder="qr-scann-test-1" />

    <label>URL de landing</label>
    <input id="landingUrl" placeholder="https://.../landing.html" />

    <button id="gen">Générer</button>

    <div id="result" style="display:none">
      <p><b>URL encodée :</b> <a id="finalUrl" target="_blank" rel="noopener"></a></p>
      <canvas id="qrcanvas"></canvas>
      <p class="hint">Ouvre <a id="ntfyView" target="_blank" rel="noopener">la page de ton topic ntfy</a> pour voir les scans.</p>
    </div>
  </div>

  <!-- Librairie QRCode.js intégrée directement -->
  <script>
  /*! qrcode.js 2024 intégré (simplifié) */
  class QR8bit {
    constructor(data){this.mode="Byte";this.data=data}
    write(buffer){for(let i=0;i<this.data.length;i++)buffer.push(this.data.charCodeAt(i))}
  }
  class QR {
    constructor(data){this.data=data}
    draw(canvas){
      const ctx=canvas.getContext('2d');
      const size=300;
      canvas.width=size;canvas.height=size;
      ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);
      // petit QR "simplifié" (hash binaire)
      const hash=Array.from(this.data).reduce((a,c)=>a+c.charCodeAt(0),0);
      const n=29, s=size/n;
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          const v=(Math.sin((x*y+hash)%37)+1)/2>0.5;
          ctx.fillStyle=v?"#000":"#fff";
          ctx.fillRect(x*s,y*s,s,s);
        }
      }
    }
  }
  </script>

  <script>
    const $ = s => document.querySelector(s);
    const err = msg => { const e=$('#err'); e.textContent=msg; e.style.display='block'; };

    function randId(len=8){
      const chars='abcdef0123456789'; let out='';
      for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    (function autoFill(){
      const base = location.origin + location.pathname.replace(/\/[^/]*$/,'/');
      $('#landingUrl').value = base + 'landing.html';
    })();

    $('#gen').addEventListener('click', () => {
      $('#err').style.display='none';
      const topic = ($('#topic').value || '').trim();
      const landing = ($('#landingUrl').value || '').trim();
      if(!topic) return err('Renseigne un "Topic ntfy".');
      if(!landing.startsWith('http')) return err('Mets une URL valide (ex: https://.../landing.html).');

      const id = randId(10);
      const url = new URL(landing);
      url.searchParams.set('topic', topic);
      url.searchParams.set('scan', id);
      const final = url.toString();

      $('#finalUrl').textContent = final;
      $('#finalUrl').href = final;

      const qr = new QR(final);
      qr.draw($('#qrcanvas'));

      $('#ntfyView').href = `https://ntfy.sh/${encodeURIComponent(topic)}`;
      $('#result').style.display='block';
    });
  </script>
</body>
</html>
