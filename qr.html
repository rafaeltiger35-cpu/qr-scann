<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>QR: Générateur (fiable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px;max-width:720px;margin:auto}
    label{display:block;margin:12px 0 4px}
    input,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
    button{cursor:pointer}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:16px}
    img{max-width:100%;height:auto;margin-top:12px}
    .error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px;border-radius:8px;display:none}
    .hint{font-size:14px;color:#555}
  </style>
</head>
<body>
  <h1>Générer un QR pour traquer les scans</h1>

  <div class="error" id="err"></div>

  <div class="card">
    <label>Topic ntfy (ex: qr-scann-test-1)</label>
    <input id="topic" placeholder="qr-scann-test-1" />

    <label>URL de landing</label>
    <input id="landingUrl" placeholder="https://.../landing.html" />

    <button id="gen">Générer</button>

    <div id="result" style="display:none">
      <p><b>URL encodée :</b> <a id="finalUrl" target="_blank" rel="noopener"></a></p>
      <img id="qrimg" alt="QR code">
      <p class="hint">Ouvre <a id="ntfyView" target="_blank" rel="noopener">la page de ton topic ntfy</a> pour voir les scans.</p>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const err = msg => { const e=$('#err'); e.textContent=msg; e.style.display='block'; };

    function randId(len=8){
      const chars='abcdef0123456789'; let out='';
      for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    // Préremplir automatiquement la landing si déployé sur GitHub Pages
    (function autoFill(){
      const base = location.origin + location.pathname.replace(/\/[^/]*$/,'/');
      $('#landingUrl').value = base + 'landing.html';
    })();

    $('#gen').addEventListener('click', () => {
      $('#err').style.display='none';
      const topic = ($('#topic').value || '').trim();
      const landing = ($('#landingUrl').value || '').trim();
      if(!topic) return err('Renseigne un "Topic ntfy" (ex: qr-scann-test-1).');
      if(!/^https?:\/\/.+\/.+\.html$/i.test(landing)) return err('Mets une URL de landing VALIDE (ex: https://.../landing.html).');

      const id = randId(10);
      const u = new URL(landing);
      u.searchParams.set('topic', topic);
      u.searchParams.set('scan', id);
      const final = u.toString();

      // Lien cliquable
      const a = $('#finalUrl'); a.textContent = final; a.href = final;

      // QR standard via Google Chart (image PNG)
      const img = $('#qrimg');
      const size = 512; // augmenter si besoin
      img.src = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chld=L|0&choe=UTF-8&chl=${encodeURIComponent(final)}`;

      // Lien vers le topic ntfy
      $('#ntfyView').href = `https://ntfy.sh/${encodeURIComponent(topic)}`;

      $('#result').style.display='block';
    });
  </script>
</body>
</html>
